import{j as e,b as M,A as B}from"./index-CtsYbnYl.js";import{a as m,z as q,G as H,g as S,d as K,L as Y}from"./icons-BchFNtE4.js";import{g as A,h as E,b as Q,d as V,u as X}from"./firebase-t0qY4c1R.js";const te=({isOpen:v,onClose:p,targetRole:u,team:x,onLoginSuccess:T,onTeamUpdate:_,t,tokenExpiredMsg:D=""})=>{const[g,N]=m.useState(""),[f,I]=m.useState(""),[U,a]=m.useState(""),[z,P]=m.useState(""),[k,w]=m.useState(!1),[j,L]=m.useState(""),[O,F]=m.useState(""),[C,d]=m.useState(!1),[Z,G]=m.useState(null),J=m.useMemo(()=>{const r=x.reduce((s,l)=>{const n=l.role||"Other";return s[n]||(s[n]=[]),s[n].push(l),s},{}),o=["GCC","Field Dispatch","Remote Ops"];return Object.entries(r).sort(([s],[l])=>{const n=o.indexOf(s),i=o.indexOf(l);return n!==-1&&i!==-1?n-i:n!==-1?-1:i!==-1?1:s.localeCompare(l)}).map(([s,l])=>({role:s,members:l.slice().sort((n,i)=>n.name.localeCompare(i.name))}))},[x]);if(m.useEffect(()=>{v&&(N(""),I(""),a(""),P(""),w(!1),L(""),F(""),d(!1),G(null))},[v,u]),!v)return null;const W=async r=>{if(r.preventDefault(),a(""),d(!0),u==="manager"||u==="admin")try{if(!g||g.length<1||g.length>500){a("Invalid password format"),d(!1);return}const o="https://us-central1-gcc-scheduler-3ef7f.cloudfunctions.net/roleLogin",s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({role:u,password:g})});if(!s.ok){const c=await s.json().catch(()=>({}));s.status===429?a("Too many login attempts. Try again later."):s.status===401?a(t.invalidPass):a(c.error||t.invalidPass),d(!1);return}const n=(await s.json())?.token;if(!n||typeof n!="string"){a("Invalid server response"),d(!1);return}const i=A();try{await i.signOut()}catch{}await E(i,n),sessionStorage.setItem("firebaseToken",n),sessionStorage.setItem("firebaseTokenRole",u),T(u,u==="admin"?"Admin":"Diretor",0),p(),d(!1)}catch(o){a(o?.code==="auth/invalid-custom-token"?"Session expired. Try again.":t.invalidPass),d(!1)}else if(u==="editor"){if(!f){a(t.selectUser),d(!1);return}const o=x.find(s=>s.id===+f);if(!o){d(!1);return}try{const s="https://us-central1-gcc-scheduler-3ef7f.cloudfunctions.net/roleLogin",l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({role:"editor",password:g,userId:o.id,team:x.map(c=>({id:c.id,name:c.name,password:c.password}))})});if(!l.ok){const c=await l.json().catch(()=>({}));l.status===429?a("Too many login attempts. Try again later."):l.status===401?a(t.invalidPass):a(c.error||t.invalidPass),d(!1);return}const i=(await l.json())?.token;if(!i||typeof i!="string"){a("Invalid server response"),d(!1);return}const h=A();try{await h.signOut()}catch{}if(await E(h,i),await new Promise(c=>{const y=h.onAuthStateChanged(b=>{b&&(y(),c(void 0))});setTimeout(()=>{y(),c(void 0)},2e3)}),sessionStorage.setItem("firebaseToken",i),sessionStorage.setItem("firebaseTokenRole","editor"),T("editor",o.name,o.id),o.requirePasswordChange){w(!0),d(!1);return}p(),d(!1)}catch(s){a(s?.code==="auth/invalid-custom-token"?"Session expired. Try again.":t.invalidPass),d(!1)}}},$=async r=>{if(r.preventDefault(),!f){a(t.selectUser);return}const o=x.find(i=>i.id===+f);if(!o)return;const s=o.password||"1234",l=s.startsWith("$2");let n=!1;if(l?n=await M.compare(g,s):n=g===s,!n){a(t.invalidPass);return}if(j!==O){a(t.passMismatch);return}if(j.length<3){a("Password too short");return}d(!0);try{const i=await M.hash(j,10),h=x.map(b=>b.id===+f?{...b,password:i,requirePasswordChange:!1}:b),c=Q(),y=V(c,"artifacts",B,"public","data","shift_scheduler","global_state");await X(y,{team:h,lastUpdated:Date.now()}),_(()=>h),P(t.passChanged),setTimeout(()=>{d(!1),p()},800)}catch(i){console.error("Password change error:",i),a("Failed to change password. Please try again."),d(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col transform transition-all",children:[e.jsxs("div",{className:"bg-indigo-600 p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 text-white",children:u==="manager"?e.jsx(q,{size:32}):e.jsx(H,{size:32})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:k?t.changePass:t.loginRequired}),e.jsx("p",{className:"text-indigo-200 text-sm mt-1",children:u==="manager"?t.managerLoginDesc:t.userLoginDesc})]}),e.jsxs("div",{className:"p-8",children:[D&&e.jsxs("div",{className:"bg-orange-50 text-orange-700 p-3 rounded-lg text-sm flex items-center gap-2 border border-orange-200 mb-4",children:[e.jsx(S,{size:16})," ",D]}),U&&e.jsxs("div",{className:"bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2 border border-red-100 animate-shake mb-4",children:[e.jsx(S,{size:16})," ",U]}),z&&e.jsxs("div",{className:"bg-green-50 text-green-600 p-3 rounded-lg text-sm flex items-center gap-2 border border-green-100 mb-4",children:[e.jsx(K,{size:16})," ",z]}),!k&&e.jsxs("form",{onSubmit:W,className:"space-y-6",children:[u==="editor"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:t.selectUser}),e.jsxs("select",{value:f,onChange:r=>I(r.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition",required:!0,children:[e.jsx("option",{value:"",children:t.selectUser}),J.map(({role:r,members:o})=>e.jsx("optgroup",{label:r,children:o.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:t.password}),e.jsx("input",{type:"password",value:g,onChange:r=>N(r.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition",placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:p,disabled:C,className:"flex-1 py-3 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",children:t.cancel}),e.jsx("button",{type:"submit",disabled:C,className:"flex-1 py-3 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:C?e.jsxs(e.Fragment,{children:[e.jsx(Y,{size:16,className:"animate-spin"}),t.login,"ing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{size:16}),t.login]})})]}),u==="editor"&&e.jsx("button",{type:"button",onClick:()=>{if(!f){a(t.selectUser);return}w(!0),a(""),P("")},className:`w-full text-sm font-medium rounded-lg px-3 py-2 border transition ${f?"text-indigo-600 bg-indigo-50 border-indigo-100 hover:text-indigo-700 hover:bg-indigo-100 hover:border-indigo-300 active:translate-y-[1px]":"text-gray-400 cursor-not-allowed bg-gray-50 border-gray-200"}`,disabled:!f,children:t.changePass})]}),k&&e.jsxs("form",{onSubmit:$,className:"space-y-6",children:[e.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 text-amber-800 text-sm rounded mb-4 flex items-start gap-2",children:[e.jsx(S,{size:18,className:"flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Password Change Required"}),e.jsxs("div",{className:"text-xs",children:["You must change your password before continuing. Updating password for:"," ",e.jsx("strong",{children:x.find(r=>r.id===+f)?.name})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:[t.password," (Current)"]}),e.jsx("input",{type:"password",value:g,onChange:r=>N(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:t.newPass}),e.jsx("input",{type:"password",value:j,onChange:r=>L(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:t.confirmPass}),e.jsx("input",{type:"password",value:O,onChange:r=>F(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"flex-1 py-2 text-sm text-gray-600 bg-gray-100 rounded",children:t.backToLogin}),e.jsx("button",{type:"submit",className:"flex-1 py-2 text-sm font-bold text-white bg-green-600 rounded",children:t.changePass})]})]})]})]})})};export{te as LoginModal};
