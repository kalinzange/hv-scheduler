import{j as e}from"./index-DmOvnXxr.js";import{a as f,z as D,G as W,t as C,c as $,L as B}from"./icons-Dv_jQHI5.js";import{b as M}from"./index-DGnxsfR-.js";import{g as q,h as F}from"./firebase-BML4XxfO.js";const V=({isOpen:j,onClose:b,targetRole:u,team:h,onLoginSuccess:w,onTeamUpdate:A,t:s,tokenExpiredMsg:S=""})=>{const[g,y]=f.useState(""),[m,T]=f.useState(""),[I,a]=f.useState(""),[U,v]=f.useState(""),[N,k]=f.useState(!1),[p,z]=f.useState(""),[L,O]=f.useState(""),[P,l]=f.useState(!1),E=f.useMemo(()=>{const r=h.reduce((i,o)=>{const d=o.role||"Other";return i[d]||(i[d]=[]),i[d].push(o),i},{}),n=["GCC","Field Dispatch","Remote Ops","TL"],t=i=>{const o=n.indexOf(i);return o===-1?n.length:o};return Object.entries(r).sort(([i],[o])=>t(i)-t(o)).map(([i,o])=>({role:i,members:o.slice().sort((d,x)=>d.name.localeCompare(x.name))}))},[h]);if(f.useEffect(()=>{j&&(y(""),T(""),a(""),v(""),k(!1),z(""),O(""),l(!1))},[j,u]),!j)return null;const G=async r=>{if(r.preventDefault(),a(""),l(!0),u==="manager"||u==="admin")try{if(!g||g.length<1||g.length>500){a("Invalid password format"),l(!1);return}const n="https://us-central1-gcc-scheduler-3ef7f.cloudfunctions.net/roleLogin",t=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({role:u,password:g})});if(!t.ok){const c=await t.json().catch(()=>({}));t.status===429?a("Too many login attempts. Try again later."):t.status===401?a(s.invalidPass):a(c.error||s.invalidPass),l(!1);return}const o=(await t.json())?.token;if(!o||typeof o!="string"){a("Invalid server response"),l(!1);return}const d=q();try{await d.signOut()}catch{}await F(d,o),sessionStorage.setItem("firebaseToken",o),sessionStorage.setItem("firebaseTokenRole",u),w(u,u==="admin"?"Admin":"Diretor",0),b(),l(!1)}catch(n){a(n?.code==="auth/invalid-custom-token"?"Session expired. Try again.":s.invalidPass),l(!1)}else if(u==="editor"){if(!m){a(s.selectUser),l(!1);return}const n=h.find(t=>t.id===+m);if(!n){l(!1);return}try{const t="https://us-central1-gcc-scheduler-3ef7f.cloudfunctions.net/roleLogin",i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({role:"editor",password:g,userId:n.id,team:h.map(c=>({id:c.id,name:c.name,password:c.password}))})});if(!i.ok){const c=await i.json().catch(()=>({}));i.status===429?a("Too many login attempts. Try again later."):i.status===401?a(s.invalidPass):a(c.error||s.invalidPass),l(!1);return}const d=(await i.json())?.token;if(!d||typeof d!="string"){a("Invalid server response"),l(!1);return}const x=q();try{await x.signOut()}catch{}await F(x,d),sessionStorage.setItem("firebaseToken",d),sessionStorage.setItem("firebaseTokenRole","editor"),w("editor",n.name,n.id),b(),l(!1)}catch(t){a(t?.code==="auth/invalid-custom-token"?"Session expired. Try again.":s.invalidPass),l(!1)}}},J=async r=>{if(r.preventDefault(),!m){a(s.selectUser);return}const n=h.find(x=>x.id===+m);if(!n)return;const t=n.password||"1234",i=t.startsWith("$2");let o=!1;if(i?o=await M.compare(g,t):o=g===t,!o){a(s.invalidPass);return}if(p!==L){a(s.passMismatch);return}if(p.length<3){a("Password too short");return}const d=await M.hash(p,10);A(x=>x.map(c=>c.id===+m?{...c,password:d,requirePasswordChange:!1}:c)),v(s.passChanged),setTimeout(()=>{w("editor",n.name,n.id),b()},800)};return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col transform transition-all",children:[e.jsxs("div",{className:"bg-indigo-600 p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 text-white",children:u==="manager"?e.jsx(D,{size:32}):e.jsx(W,{size:32})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:N?s.changePass:s.loginRequired}),e.jsx("p",{className:"text-indigo-200 text-sm mt-1",children:u==="manager"?s.managerLoginDesc:s.userLoginDesc})]}),e.jsxs("div",{className:"p-8",children:[S&&e.jsxs("div",{className:"bg-orange-50 text-orange-700 p-3 rounded-lg text-sm flex items-center gap-2 border border-orange-200 mb-4",children:[e.jsx(C,{size:16})," ",S]}),I&&e.jsxs("div",{className:"bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2 border border-red-100 animate-shake mb-4",children:[e.jsx(C,{size:16})," ",I]}),U&&e.jsxs("div",{className:"bg-green-50 text-green-600 p-3 rounded-lg text-sm flex items-center gap-2 border border-green-100 mb-4",children:[e.jsx($,{size:16})," ",U]}),!N&&e.jsxs("form",{onSubmit:G,className:"space-y-6",children:[u==="editor"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:s.selectUser}),e.jsxs("select",{value:m,onChange:r=>T(r.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition",required:!0,children:[e.jsx("option",{value:"",children:s.selectUser}),E.map(({role:r,members:n})=>e.jsx("optgroup",{label:r,children:n.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:s.password}),e.jsx("input",{type:"password",value:g,onChange:r=>y(r.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition",placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:b,disabled:P,className:"flex-1 py-3 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",children:s.cancel}),e.jsx("button",{type:"submit",disabled:P,className:"flex-1 py-3 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:P?e.jsxs(e.Fragment,{children:[e.jsx(B,{size:16,className:"animate-spin"}),s.login,"ing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{size:16}),s.login]})})]}),u==="editor"&&e.jsx("button",{type:"button",onClick:()=>{if(!m){a(s.selectUser);return}k(!0),a(""),v("")},className:`w-full text-sm font-medium rounded-lg px-3 py-2 border transition ${m?"text-indigo-600 bg-indigo-50 border-indigo-100 hover:text-indigo-700 hover:bg-indigo-100 hover:border-indigo-300 active:translate-y-[1px]":"text-gray-400 cursor-not-allowed bg-gray-50 border-gray-200"}`,disabled:!m,children:s.changePass})]}),N&&e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 text-amber-800 text-sm rounded mb-4 flex items-start gap-2",children:[e.jsx(C,{size:18,className:"flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Password Change Required"}),e.jsxs("div",{className:"text-xs",children:["You must change your password before continuing. Updating password for:"," ",e.jsx("strong",{children:h.find(r=>r.id===+m)?.name})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:[s.password," (Current)"]}),e.jsx("input",{type:"password",value:g,onChange:r=>y(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:s.newPass}),e.jsx("input",{type:"password",value:p,onChange:r=>z(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:s.confirmPass}),e.jsx("input",{type:"password",value:L,onChange:r=>O(r.target.value),className:"w-full p-2 border rounded"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>k(!1),className:"flex-1 py-2 text-sm text-gray-600 bg-gray-100 rounded",children:s.backToLogin}),e.jsx("button",{type:"submit",className:"flex-1 py-2 text-sm font-bold text-white bg-green-600 rounded",children:s.changePass})]})]})]})]})})};export{V as LoginModal};
