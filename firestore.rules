rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user has write permission
    function hasWriteAccess() {
      return request.auth != null &&
             request.auth.token.role in ['manager', 'admin'];
    }

    // Validate essential fields only to prevent corruption while allowing schema flexibility
    function isValidGlobalState() {
      let data = request.resource.data;

      // Check critical required fields exist
      let hasCriticalFields = data.keys().hasAll([
        'overrides',
        'publishedOverrides',
        'team',
        'lastUpdated',
        'config'
      ]);

      // Type validation for critical fields
      let criticalTypesValid =
        data.overrides is map &&
        data.publishedOverrides is map &&
        data.team is list &&
        data.lastUpdated is number &&
        data.config is map;

      // Array size constraints (prevent abuse)
      let arraysSizeValid =
        data.team.size() <= 1000 &&
        (!('requests' in data) || data.requests.size() <= 10000);

      // Timestamp validation: not before 2000, allow +10 min for clock skew
      let timestampValid =
        data.lastUpdated >= 946684800000 && // Jan 1, 2000
        data.lastUpdated <= now.getTime() + 600000;

      return hasCriticalFields && criticalTypesValid && arraysSizeValid && timestampValid;
    }

    // ============================================
    // FIRESTORE RULES
    // ============================================

    // Public read access to schedule
    match /artifacts/{appId}/public/data/shift_scheduler/global_state {
      allow read: if true; // Public read - schedule is non-sensitive

      allow write: if hasWriteAccess() && isValidGlobalState();

      allow update: if hasWriteAccess() && isValidGlobalState();

      allow delete: if false; // Never allow deletion
    }

    // Audit logs: readable by manager/admin, written by Cloud Function only
    match /artifacts/{appId}/private/audit_logs/{document=**} {
      allow read: if request.auth != null &&
                     request.auth.token.role in ['manager', 'admin'];

      allow write: if false; // Cloud Function writes these via admin SDK
      allow create: if false;
      allow update: if false;
      allow delete: if false; // Immutable audit trail
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
