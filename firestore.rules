rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user has write permission
    function hasWriteAccess() {
      return request.auth != null &&
             request.auth.token.role in ['manager', 'admin'];
    }

    // Validate global state structure and constraints
    function isValidGlobalState() {
      let data = request.resource.data;

      // All required fields must be present
      let hasAllFields = data.keys().hasAll([
        'startDateStr',
        'holidays',
        'minStaff',
        'requiredLangs',
        'weekendDays',
        'legends',
        'colors',
        'overrides',
        'publishedOverrides',
        'config',
        'hoursConfig',
        'team',
        'requests',
        'lastUpdated',
        'lastPublished'
      ]);

      // Type validation
      let typesValid =
        data.startDateStr is string &&
        data.holidays is list &&
        data.minStaff is map &&
        data.requiredLangs is list &&
        data.weekendDays is list &&
        data.legends is map &&
        data.colors is map &&
        data.overrides is map &&
        data.publishedOverrides is map &&
        data.config is map &&
        data.hoursConfig is map &&
        data.team is list &&
        data.requests is list &&
        data.lastUpdated is number &&
        (data.lastPublished is number || data.lastPublished == null);

      // String length constraints
      let stringsValid =
        data.startDateStr.size() <= 20;

      // Array size constraints (prevent abuse)
      let arraysValid =
        data.team.size() <= 1000 &&
        data.requests.size() <= 10000 &&
        data.holidays.size() <= 500 &&
        data.requiredLangs.size() <= 100 &&
        data.weekendDays.size() <= 10;

      // Timestamp validation: not more than 1 minute in future, not before 2000
      let timestampValid =
        data.lastUpdated >= 946684800000 && // Jan 1, 2000
        data.lastUpdated <= now.getTime() + 60000; // +1 minute

      // Config sanity checks
      let configValid =
        data.config.morningDays is number &&
        data.config.afternoonDays is number &&
        data.config.nightDays is number &&
        data.config.morningDays > 0 &&
        data.config.afternoonDays > 0 &&
        data.config.nightDays > 0 &&
        data.config.morningDays <= 30 &&
        data.config.afternoonDays <= 30 &&
        data.config.nightDays <= 30;

      // Hours config validation
      let hoursValid =
        data.hoursConfig is map &&
        data.hoursConfig.M is number &&
        data.hoursConfig.T is number &&
        data.hoursConfig.N is number;

      return hasAllFields && typesValid && stringsValid && arraysValid &&
             timestampValid && configValid && hoursValid;
    }

    // ============================================
    // FIRESTORE RULES
    // ============================================

    // Public read access to schedule
    match /artifacts/{appId}/public/data/shift_scheduler/global_state {
      allow read: if true; // Public read - schedule is non-sensitive

      allow write: if hasWriteAccess() && isValidGlobalState();

      allow update: if hasWriteAccess() && isValidGlobalState();

      allow delete: if false; // Never allow deletion
    }

    // Audit logs: readable by manager/admin, written by Cloud Function only
    match /artifacts/{appId}/private/audit_logs/{document=**} {
      allow read: if request.auth != null &&
                     request.auth.token.role in ['manager', 'admin'];

      allow write: if false; // Cloud Function writes these via admin SDK
      allow create: if false;
      allow update: if false;
      allow delete: if false; // Immutable audit trail
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
